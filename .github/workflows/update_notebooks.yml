name: update notebooks and statistics

on:
  schedule:
    # At 13:00 on every Monday (after data update at 08:00)
    - cron: '0 13 * * 1'
  workflow_dispatch:

jobs:
  update-notebooks:
    runs-on: ubuntu-latest

    steps:
      - name: Check if it's the second Monday of the month or manual trigger
        id: check_second_monday
        run: |
          echo "RUN_JOBS=$(python -c "import datetime, sys; today=datetime.date.today(); first_day=today.replace(day=1); first_monday=first_day+datetime.timedelta(days=(7-first_day.weekday())%7); second_monday=first_monday+datetime.timedelta(days=7); print('true' if today==second_monday or '${{ github.event_name }}'=='workflow_dispatch' else 'false')")" >> $GITHUB_ENV
        shell: bash

      - name: Checkout repository
        if: env.RUN_JOBS == 'true'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup uv
        if: env.RUN_JOBS == 'true'
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          uv sync --python 3.13

      - name: Download all datasets from Hugging Face
        if: env.RUN_JOBS == 'true'
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          uv run hf download piebro/osm-data --repo-type=dataset --local-dir=.
          echo "Dataset sizes:"
          du -sh changeset_data changeset_comments_data notes_data notes_comments_data

      - name: Run all notebooks with timings
        if: env.RUN_JOBS == 'true'
        run: |
          cd notebooks && for notebook in *.ipynb; do
            echo "Running $notebook...";
            start_time=$(date +%s);
            NOTEBOOK_NAME="${notebook%.ipynb}" uv run jupyter execute --inplace "$notebook";
            end_time=$(date +%s);
            echo "Completed $notebook in $((end_time - start_time)) seconds";
          done && cd ..

      - name: Convert notebooks to HTML
        if: env.RUN_JOBS == 'true'
        run: |
          uv run scripts/notebook_to_html.py

      - name: Configure Git
        if: env.RUN_JOBS == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push changes
        if: env.RUN_JOBS == 'true'
        run: |
          git add notebooks/ stats/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update notebooks and statistics"
            git push
            echo "Changes committed and pushed successfully"
          fi