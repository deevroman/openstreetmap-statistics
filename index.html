<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" >
  <meta name="viewport" content="width=800">
  <meta name="description" content="Monthly updated interactive statistics of OpenStreetMap.">
  <title>OpenStreetMap Statistics</title>
  <script src="assets/plotly-custom.min.js"></script>
  <link rel="stylesheet" type="text/css" href="index.css">
  <script defer data-domain="piebro.github.io/openstreetmap-statistics" src="https://plausible.io/js/plausible.js"></script>
</head>

<script>

// TODO: add units to the data file?
topics = {
    "general": {
        "How many people are contributing each month?": {
            "url_hash": "63f6",
            "content_functions": [
                single_line_plot("monthly_contributor_count", "contributors per month", "contributors"),
                single_line_plot("monthly_new_contributor_count", "new contributors per month", "contributors"),
                multi_line_plot("monthly_contributors_count_more_then_k_edits", "contributors with more then k edits total", "contributors")
            ]
        },
        "Why is there rapid growth in monthly contributors in 2016?":{
            "url_hash": "21d9",
            "content_functions": [
                text_div("That's because a lot of new people were contributing using the maps.me app. Looking at the plot of" + 
                         " monthly contributors not using maps.me shows that there is linear growth. It is also worth noting" +
                         " that vast majority of maps.me mappers made only few edits. And due to definciencies in provided" +
                         " editor quality of their edits was really low."),
                single_line_plot("monthly_contributor_count_no_maps_me", "contributors per month without maps.me contributors", "contributors")
            ]
        },
        "How many edits are added each month?": {
            "url_hash": "fe79",
            "content_functions":[
                single_line_plot("monthly_edits", "edits per month", "edits")
            ]
        },
        "What's the total amount of contributors, edits and changesets over time?": {
            "url_hash": "7026",
            "content_functions":[
                single_line_plot("monthly_contributor_cumsum", "total contributor count", "contributors"),
                single_line_plot("monthly_edits_cumsum", "total edit count", "edits"),
                single_line_plot("monthly_changesets_cumsum", "total changeset count", "changesets"),
            ]
        }
    }
}



selection_options = {}
url_hash_to_topic_question = {}
for (const [topic, topic_obj] of Object.entries(topics)) {
    selection_options[topic] = {}
    for (const [question, question_obj] of Object.entries(topic_obj)) {
        selection_options[topic][question] = {}
        url_hash_to_topic_question[question_obj["url_hash"]] = [topic, question]
    }
}

function options_to_selection(select, keys){
    prev_value = select.value
    while (select.firstChild) {
        select.removeChild(select.lastChild)
    }
    for (key of keys){
        var opt = document.createElement('option')
        opt.value = key
        opt.innerHTML = key.replaceAll("_", " ")
        select.appendChild(opt)
    }
    if (keys.includes(prev_value)){
        select.value = prev_value
    }
}

async function load_data(data_name){
    return await fetch("assets/data/" + data_name + ".json").then(response => {return response.json()})
}

function add_div(id, class_str){
    let div = document.createElement('div')
    div.id = String(id)
    div.style.display = "inline-block"
    div.classList.add(class_str);
    document.getElementById('data').appendChild(div)
    return div
}

function text_div(text){
    show_content = async function(div_id){
        div = add_div(div_id, "textDiv")
        div.insertAdjacentHTML('beforeend', text);
    }
    return {"show": show_content}
}

function get_line_plot_config(){
    return {"displayModeBar": false, "staticPlot":(screen.width < 850)}
}

function get_line_plot_layout(plot_title, unit){
    return {
        "font": {"family": "Times", "size": "15"},
        "paper_bgcolor": "#dfdfdf",
        "plot_bgcolor": "#dfdfdf",
        "margin": {"l": 55, "r": 55, "b": 55, "t": 55},
        "title": {"text": plot_title},
        "xaxis": {"title": {"text": "time"}},
        "yaxis": {"title": {"text": unit}, "rangemode": "tozero"},
    }
}

function single_line_plot(data_name, plot_title, unit){
    show_content = async function(div_id){
        data = await load_data(data_name)
        div = add_div(div_id, "dataDiv")
        traces = [{"x": data["month"], "y": data[data_name], "mode": "lines", "name": "", "hovertemplate": "%{x}<br>%{y:,} " + unit}]
        Plotly.newPlot(div, traces, get_line_plot_layout(plot_title, unit), get_line_plot_config())
    }
    return {"show": show_content}
}


function multi_line_plot(data_name, plot_title, unit){
    show_content = async function(div_id){
        data = await load_data(data_name)
        div = add_div(div_id, "dataDiv")
        traces = []
        for (const [y_name, y] of Object.entries(data[data_name])) {
            traces.push({"x": data["month"], "y": y, "mode": "lines", "name": y_name, "hovertemplate": "%{x}<br>%{y:,} " + unit})
        }
        Plotly.newPlot(div, traces, get_line_plot_layout(plot_title, unit), get_line_plot_config())
    }
    return {"show": show_content}
}

function init(){
    update_select_0()
    if(window.location.hash) {
        url_hash = window.location.hash.substring(1)
        if (url_hash in url_hash_to_topic_question){
            topic = url_hash_to_topic_question[url_hash][0]
            question = url_hash_to_topic_question[url_hash][1]
            if (topic in selection_options && question in selection_options[topic]){
                document.getElementById('select_0').value = topic
                update_select_1()
                document.getElementById('select_1').value = question
            }
        }
    }
    update_content()
    window.addEventListener('resize', function(event) {update_content()}, true);
}

function update_select_0(){
    options_to_selection(document.getElementById('select_0'), Object.keys(selection_options))
    update_select_1()
}

function update_select_1(){
    current_select_0 = document.getElementById('select_0').value
    options_to_selection(document.getElementById('select_1'), Object.keys(selection_options[current_select_0]))
}

function on_change_select_0(){
    update_select_1()
    update_content()
}

function on_change_select_1(){
    update_content()
}

function get_current_select(){
    return [document.getElementById('select_0').value, document.getElementById('select_1').value]
}

async function update_content(){
    document.getElementById("data").innerHTML = ""  
    topic_question = get_current_select()
    topic = topic_question[0]
    question = topic_question[1]
    console.log(topic, question)

    for (const [index, content_functions] of topics[topic][question]["content_functions"].entries()){
        await content_functions["show"](index)
    }

    // document.getElementById('save_plot_btn').onclick = data[topic][question]["save_plot"]
    // document.getElementById('save_data_btn').onclick = data[topic][question]["save_data"]
    history.replaceState(null, "", "#" + topics[topic][question]["url_hash"])
}
</script>


<body onload="init()">
<h2>OpenStreetMap Statistics</h2>
<div class="textDiv" style="padding-top: 0;">
The <a href="https://github.com/piebro/openstreetmap-statistics">code</a> for creating the plots is open source. There is also some documentation describing the <a href="https://github.com/piebro/openstreetmap-statistics#methodology">methodology</a> and what to consider when interpreting the data.
</div>
<div>
    <select onchange="on_change_select_0()" id="select_0"></select>
    <select onchange="on_change_select_1()" id="select_1"></select>
</div>
<div id="data"></div>
<div>
    <button id="save_plot_btn">save plot(s)</button>
    <button id="save_data_btn">save data</button>
</div>
</br>
</body>
</html>